<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.medical.mapper.DepartmentMapper">

    <select id="page" resultType="com.medical.vo.DepartmentPageQueryVO">
        select dept.id, dept.dept_code, dept.dept_name, dept.dept_type, dept.parent_id, dept.level,
               dept.description, dept.location, dept.phone, dept.director_id, d.real_name as directorName,
               dept.bed_count, dept.consultation_fee, dept.sort_order, dept.status, dept.is_outpatient,
               dept.is_inpatient, dept.is_emergency, dept.create_time, dept.update_time, dept.create_admin,
               dept.update_admin
              from department dept
        left join doctor d on dept.director_id = d.id
        <where>
            <if test="deptName != null">
                and dept.dept_name like concat('%', #{deptName}, '%')
            </if>
            <if test="status != null">
                and dept.status = #{status}
            </if>
            <if test="deptType != null">
                and dept.dept_type = #{deptType}
            </if>
            <if test="directId != null">
                and dept.director_id = #{directId}
            </if>
            <if test="isOutpatient != null">
                and dept.is_outpatient = #{isOutpatient}
            </if>
            <if test="isInpatient != null">
                and dept.is_inpatient = #{isInpatient}
            </if>
            <if test="isEmergency != null">
                and dept.is_emergency = #{isEmergency}
            </if>
        </where>
        order by dept.sort_order asc
    </select>

    <insert id="insert">
        insert into department (dept_code, dept_name, dept_type, parent_id, level, description, location, phone, director_id,
                                bed_count, consultation_fee, sort_order, status, is_outpatient, is_inpatient, is_emergency,
                               create_time, update_time, create_admin, update_admin)
        values (#{deptCode}, #{deptName}, #{deptType}, #{parentId}, #{level}, #{description}, #{location}, #{phone}, #{directorId},
                #{bedCount}, #{consultationFee}, #{sortOrder}, #{status}, #{isOutpatient}, #{isInpatient}, #{isEmergency},
                #{createTime}, #{updateTime}, #{createAdmin}, #{updateAdmin})
    </insert>



    <!-- 更新部门信息 -->
    <update id="update">
        update department
        <set>
            <if test="deptName != null">
                dept_name = #{deptName},
            </if>
            <if test="description != null">
                description = #{description},
            </if>
            <if test="location != null">
                location = #{location},
            </if>
            <if test="phone != null">
                phone = #{phone},
            </if>
            <if test="directorId != null">
                director_id = #{directorId},
            </if>
            <if test="deptType != null">
                dept_type = #{deptType},
            </if>
            <if test="parentId != null">
                parent_id = #{parentId},
            </if>
            <if test="level != null">
                level = #{level},
            </if>
            <if test="bedCount != null">
                bed_count = #{bedCount},
            </if>
            <if test="consultationFee != null">
                consultation_fee = #{consultationFee},
            </if>
            <if test="sortOrder != null">
                sort_order = #{sortOrder},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
            <if test="isOutpatient != null">
                is_outpatient = #{isOutpatient},
            </if>
            <if test="isInpatient != null">
                is_inpatient = #{isInpatient},
            </if>
            <if test="isEmergency != null">
                is_emergency = #{isEmergency},
            </if>
            <if test="updateTime != null">
                update_time = #{updateTime},
            </if>
            <if test="updateAdmin != null">
                update_admin = #{updateAdmin},
            </if>
        </set>
        where id = #{id}
    </update>

    <delete id="deleteBatch">
        delete from department where id in
        <foreach item="id" collection="ids" separator="," open="(" close=")">
            #{id}
        </foreach>
    </delete>


    <!-- 清除指定医生的主任身份 -->
    <update id="clearDirector">
        update department set director_id = null, update_time = now()
        where director_id = #{doctorId}
    </update>

</mapper>
